/*! city-select - v0.1.0 - 2016-01-25
* https://github.com/jeffrey/city-select
* Copyright (c) 2016 x010; Licensed MIT */
!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a(window.jQuery||window.Zepto||window.$)}(function(a){a.cxSelect=function(){var b={dom:{},api:{}};return b.init=function(){var b,c,d,e,f=this,g=function(a){return a&&("function"==typeof HTMLElement||"object"==typeof HTMLElement)&&a instanceof HTMLElement?!0:a&&a.nodeType&&1===a.nodeType?!0:!1},h=function(a){return a&&a.length&&("function"==typeof jQuery||"object"==typeof jQuery)&&a instanceof jQuery?!0:!1};for(c=0,d=arguments.length;d>c;c++)h(arguments[c])?f.dom.box=arguments[c]:g(arguments[c])?f.dom.box=a(arguments[c]):"object"==typeof arguments[c]&&(b=arguments[c]);if(f.dom.box.length&&(f.settings=a.extend({},a.cxSelect.defaults,b,{url:f.dom.box.data("url"),nodata:f.dom.box.data("nodata"),required:f.dom.box.data("required"),firstTitle:f.dom.box.data("firstTitle"),firstValue:f.dom.box.data("firstValue"),jsonSpace:f.dom.box.data("jsonSpace"),jsonName:f.dom.box.data("jsonName"),jsonValue:f.dom.box.data("jsonValue"),jsonSub:f.dom.box.data("jsonSub")}),e=f.dom.box.data("selects"),"string"==typeof e&&e.length&&(f.settings.selects=e.split(",")),a.isArray(f.settings.selects)&&f.settings.selects.length)){for(f.selectArray=[],c=0,d=f.settings.selects.length;d>c&&f.dom.box.find("select."+f.settings.selects[c]);c++)f.selectArray.push(f.dom.box.find("select."+f.settings.selects[c]));f.selectArray.length&&(f.dom.box.on("change","select",function(){f.selectChange(this.className)}),f.settings.url?"string"==typeof f.settings.url?a.getJSON(f.settings.url,function(a){f.start(a)}):"object"==typeof f.settings.url&&f.start(f.settings.url):f.start())}},b.getIndex=function(a){return this.settings.required?a:a-1},b.start=function(a){var b,c,d,e=this,f=e.settings.jsonSpace;if(e.dataJson=void 0,a&&"object"==typeof a&&(e.dataJson=a,"string"==typeof f&&f.length))for(b=f.split("."),c=0,d=b.length;d>c;c++)e.dataJson=e.dataJson[b[c]];e.getOptionData(0)},b.selectChange=function(a){var b,c,d;if("string"==typeof a&&a.length){for(a=a.replace(/\s+/g,","),a=","+a+",",c=0,d=this.selectArray.length;d>c;c++)a.indexOf(","+this.settings.selects[c]+",")>-1&&(b=c);"number"==typeof b&&(b+=1,this.getOptionData(b))}},b.getOptionData=function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o=this;if(!("number"!=typeof b||isNaN(b)||0>b||b>=o.selectArray.length)){for(c=b-1,d=o.selectArray[b],h={},i=d.data("url"),j="undefined"==typeof d.data("jsonSpace")?o.settings.jsonSpace:d.data("jsonSpace"),m=0,n=o.selectArray.length;n>m;m++)m>=b&&(o.selectArray[m].empty().prop("disabled",!0),"none"===o.settings.nodata?o.selectArray[m].css("display","none"):"hidden"===o.settings.nodata&&o.selectArray[m].css("visibility","hidden"));if("string"==typeof i&&i.length){if(c>=0){if(!o.selectArray[c].val().length)return;k=d.data("queryName"),l=o.selectArray[c].attr("name"),"string"==typeof k&&k.length?h[k]=o.selectArray[c].val():"string"==typeof l&&l.length&&(h[l]=o.selectArray[c].val())}a.getJSON(i,h,function(a){var b,c,e;if(f=a,"string"==typeof j&&j.length)for(b=j.split("."),c=0,e=b.length;e>c;c++)f=f[b[c]];o.buildOption(d,f)})}else if(o.dataJson&&"object"==typeof o.dataJson){for(f=o.dataJson,m=0,n=o.selectArray.length;n>m;m++)b>m&&(g=o.getIndex(o.selectArray[m][0].selectedIndex),"object"==typeof f[g]&&a.isArray(f[g][o.settings.jsonSub])&&f[g][o.settings.jsonSub].length&&(e=m,f=f[g][o.settings.jsonSub]));(0>c||c===e)&&o.buildOption(d,f)}}},b.buildOption=function(b,c){var d,e,f,g=this,h="undefined"==typeof b.data("firstTitle")?g.settings.firstTitle:String(b.data("firstTitle")),i="undefined"==typeof b.data("firstValue")?g.settings.firstValue:String(b.data("firstValue")),j="undefined"==typeof b.data("jsonName")?g.settings.jsonName:String(b.data("jsonName")),k="undefined"==typeof b.data("jsonValue")?g.settings.jsonValue:String(b.data("jsonValue"));if(a.isArray(c)){if(d=g.settings.required?"":'<option value="'+i+'">'+h+"</option>",j.length)for(k.length||(k=j),e=0,f=c.length;f>e;e++)d+='<option value="'+String(c[e][k])+'">'+String(c[e][j])+"</option>";else for(e=0,f=c.length;f>e;e++)d+='<option value="'+String(c[e])+'">'+String(c[e])+"</option>";b.html(d).prop("disabled",!1).css({display:"",visibility:""}),"undefined"!=typeof b.data("value")&&b.val(String(b.data("value"))).removeData("value").removeAttr("data-value"),b.trigger("change")}},b.init.apply(b,arguments),this},a.cxSelect.defaults={selects:[],url:null,nodata:null,required:!1,firstTitle:"请选择",firstValue:"",jsonSpace:"",jsonName:"n",jsonValue:"",jsonSub:"s"},a.fn.cxSelect=function(b,c){return this.each(function(){a.cxSelect(this,b,c)}),this}});